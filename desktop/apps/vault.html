<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VAULT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
	<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: black;
  overflow: hidden;
  font-family: "Courier New", monospace;
  color: #00ffcc;
}

#vaultRoot {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}
		
.vault-frame {
  width: 97%;
  height: 96%;
  border: 2px solid #00ffcc;
  background: radial-gradient(circle at center, #021111, #000);
  box-shadow: 0 0 30px rgba(0,255,204,0.25);
  display: flex;
  flex-direction: column;
}

.vault-title {
  padding: 8px 12px;
  font-size: 13px;
  border-bottom: 1px solid #00ffcc;
}

.vault-graph {
  flex: 1;
  position: relative;
  overflow: hidden;
}

.vault-map {
  position: absolute;
  inset: 0;
}

.vault-graph::before {
  content: "";
  position: absolute;
  inset: 0;
  margin: auto;
  width: 420px;
  height: 420px;
  border-radius: 50%;
  border: 1px dashed rgba(0,255,204,0.15);
  z-index: 0;
}

.node {
  position: absolute;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #041818;
  border: 2px solid #00ffcc;
  opacity: 0.25;
  cursor: pointer;
  transition: transform .2s, opacity .2s, box-shadow .2s;
  z-index: 2;
}

.node.unlocked {
  opacity: 1;
}

.node.unlocked:hover {
  transform: scale(1.2);
  box-shadow: 0 0 16px rgba(0,255,204,0.8);
}

.node.final {
  width: 54px;
  height: 54px;
  background: radial-gradient(circle, #00ffcc, #003333);
  color: black;
  font-weight: bold;
}

.connection {
  position: absolute;
  height: 2px;
  background: rgba(0,255,204,0.35);
  transform-origin: left center;
  z-index: 1;
}

.vault-panel {
  border-top: 1px solid #00ffcc;
  padding: 14px;
  text-align: center;
}

.vault-prompt {
  font-size: 12px;
  opacity: 0.6;
}

.question-panel {
  margin-top: 10px;
}

.question-panel.hidden {
  display: none;
}

.question-panel input {
  background: black;
  border: 1px solid #00ffcc;
  color: #00ffcc;
  padding: 8px;
  width: 260px;
  margin-top: 10px;
  text-align: center;
}

.question-panel button {
  margin-top: 14px;
  padding: 8px 24px;
  background: black;
  border: 2px solid #00ffcc;
  color: #00ffcc;
  cursor: pointer;
}

#feedback {
  height: 18px;
  margin-top: 10px;
}

#minimizePanel {
  margin-left: 5px;
  padding: 5px 4px;
  border: 1px solid #00ffcc;
  background: black;
  color: #00ffcc;
  cursor: pointer;
  opacity: 0.7;
}

#minimizePanel:hover {
  opacity: 1;
}
</style>
</head>

<body>
  <div id="vaultRoot">
    <div class="vault-frame">
      <div class="vault-title">
        VAULT ACCESS NODE
      </div>
      <div class="vault-graph">
        <div class="vault-map" id="vaultGraph"></div>
      </div>
      <div class="vault-panel">
        <p class="vault-prompt" id="vaultPrompt">Select a node.</p>
        <div class="question-panel hidden" id="questionPanel">
          <p id="qText"></p>
          <input
            type="text"
            id="answerInput"
            autocomplete="off"
            spellcheck="false"
          >
          <button id="submitAnswer">
            SUBMIT
          </button>
					<button id="minimizePanel">
						BACK
					</button>
          <div id="feedback"></div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWWUW8Q-Y45U6WNlzL0-nkKDrkErcsf88",
  authDomain: "vaultgri.firebaseapp.com",
  projectId: "vaultgri",
  storageBucket: "vaultgri.firebasestorage.app",
  messagingSenderId: "390092427827",
  appId: "1:390092427827:web:6871164cf35f62347e8946",
  measurementId: "G-DQ80LXBBEP"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const vaultDoc = doc(db, "vault", "progress");

const answers = [
  ["1946", "preservation", "valentine", "40"],
  ["obsolescence", "ebb-0", "watcher", "30"],
  ["continuity", "echo", "delta-black", "20"],
  ["1972", "observer", "human error", "10"]
];

const questions = [
  ["DELTA founding year?", "Original directive?", "Who signed the charter?", "a?"],
  ["Primary threat?", "First system name?", "Hidden protocol?", "b?"],
  ["EBB obsession?", "Failed experiment?", "Lost archive?", "c?"],
  ["Monitoring began?", "System anomaly?", "Trust breach?", "d?"]
];

const finalQuestion = {
  q: "FINAL KEY PHRASE",
  a: "always watching"
};

const graph = document.getElementById("vaultGraph");
const panel = document.getElementById("questionPanel");
const qText = document.getElementById("qText");
const input = document.getElementById("answerInput");
const feedback = document.getElementById("feedback");

let globalData = { unlocked: {} };
let activeNode = null;

const NODE_R = 18;
const FINAL_R = 27;

function polar(cx, cy, r, a) {
  return [cx + Math.cos(a) * r, cy + Math.sin(a) * r];
}

function drawConnection(x1, y1, x2, y2, r1, r2) {
  const line = document.createElement("div");

  const dx = x2 - x1;
  const dy = y2 - y1;
  const angle = Math.atan2(dy, dx);

  const startX = x1 + Math.cos(angle) * r1;
  const startY = y1 + Math.sin(angle) * r1;
  const endX   = x2 - Math.cos(angle) * r2;
  const endY   = y2 - Math.sin(angle) * r2;

  const length = Math.hypot(endX - startX, endY - startY);

  line.className = "connection";
  line.style.left = startX + "px";
  line.style.top  = startY + "px";
  line.style.width = length + "px";
  line.style.transform = `rotate(${angle}rad)`;

  graph.appendChild(line);
}

function createNode(id, x, y, r, final = false) {
  const n = document.createElement("div");
  n.className = "node" + (final ? " final" : "");
  n.style.left = (x - r) + "px";
  n.style.top = (y - r) + "px";
  n.dataset.id = id;
  if (globalData.unlocked[id]) n.classList.add("unlocked");
	  if (final) {
	  n.onclick = () => openNode(id, true);
	} else if (globalData.unlocked[id] || id.endsWith("-0")) {
	  n.classList.add("unlocked");
	  n.onclick = () => openNode(id, false);
	} else {
	  n.style.pointerEvents = "none";
	}
  graph.appendChild(n);
  return n;
}

async function loadProgress(){
  const snap = await getDoc(vaultDoc);
  globalData = snap.exists() ? snap.data() : { unlocked: {} };
}

async function unlock(id){
  globalData.unlocked[id] = true;
  await setDoc(vaultDoc, globalData, { merge: true });
}

function layout() {
  const w = graph.clientWidth;
  const h = graph.clientHeight;
  const cx = w / 2;
  const cy = h / 2;

  const rings = [0.42, 0.32, 0.22, 0.14].map(v => Math.min(w, h) * v);
  const baseAngles = [-Math.PI/2, Math.PI/2];

  const branches = [];
  baseAngles.forEach((base, bi) => {
    for (let s of [-1, 1]) {
      const b = [];
      rings.forEach((r, i) => {
        b.push(polar(cx, cy, r, base + s * (0.35 + i * 0.15)));
      });
      branches.push(b);
    }
  });

  return { cx, cy, branches };
}
	
async function render() {
  graph.innerHTML = "";
  await loadProgress();

  const L = layout();

  L.branches.forEach((b, bi) => {
    b.forEach((p, i) => {
      const id = `${bi}-${i}`;
      const n = createNode(id, p[0], p[1], NODE_R);
      if (i > 0) drawConnection(b[i-1][0], b[i-1][1], p[0], p[1], NODE_R, NODE_R);
    });
  });

  L.branches.forEach(b => {
    drawConnection(b.at(-1)[0], b.at(-1)[1], L.cx, L.cy, NODE_R, FINAL_R);
  });

  const finalUnlocked = L.branches.every((_, i) => globalData.unlocked[`${i}-3`]);
  const f = createNode("final", L.cx, L.cy, FINAL_R, true);
  if (finalUnlocked) f.classList.add("unlocked");
}

const prompt = document.getElementById("vaultPrompt");
document.getElementById("minimizePanel").onclick = () => {
  panel.classList.add("hidden");
  prompt.style.display = "block";
	render();
};
	
function openNode(id, isFinal = false) {
  // FINAL NODE
  if (isFinal) {
    if (!globalData.unlocked["final"]) return;

    activeNode = "final";
    panel.classList.remove("hidden");
    qText.textContent = finalQuestion.q;
    input.value = "";
    feedback.textContent = "";
    return;
  }

  // REGULAR NODE
  if (!globalData.unlocked[id] && !id.endsWith("-0")) return;

  activeNode = id;

  const [b, i] = id.split("-").map(Number);

  panel.classList.remove("hidden");
  qText.textContent = questions[b][i];
  input.value = "";
  feedback.textContent = "";
}


document.getElementById("submitAnswer").onclick = async () => {
  const val = input.value.trim().toLowerCase();
  if(!val) return;

  if(activeNode === "final"){
    if(val === finalQuestion.a){
      window.open("/final-log","_blank");
    } else {
      feedback.textContent = "INCORRECT";
      feedback.style.color = "red";
    }
    return;
  }

  const [b,i] = activeNode.split("-").map(Number);
  if (val === answers[b][i]) {
  await unlock(activeNode);

  const nextId = `${b}-${i + 1}`;
  if (answers[b][i + 1]) {
    await unlock(nextId);
  }

  feedback.textContent = "ACCESS GRANTED";
  feedback.style.color = "#00ffcc";
} else {
    feedback.textContent = "INCORRECT";
    feedback.style.color = "red";
  }
};

render();

window.addEventListener("resize", render);

</script>
</body>
</html>
